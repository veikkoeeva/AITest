name: AITest Build

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    paths-ignore:
      - "**.md"
  schedule:
    - cron: "0 0 * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_ENVIRONMENT: CI
  BUILD_CONFIGURATION: Release
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true
  NUGET_XMLDOC_MODE: skip
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
  NUGET_FEED: https://api.nuget.org/v3/index.json
  GITHUB_USER: ${{ github.repository_owner }}
  ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
  ANDROID_HOME: ${{ github.workspace }}/android-sdk
  ANDROID_API_LEVEL: 36
  PYTHON_PROJECT_PATH: src/AITest.PythonAI
  UV_CACHE_DIR: ${{ github.workspace }}/.uv-cache

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602
        with:
          cache: true
          cache-dependency-path: '**/packages.lock.json'
          global-json-file: global.json

      - name: Setup Python with uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244
        with:
          enable-cache: true
          cache-dependency-glob: '${{ env.PYTHON_PROJECT_PATH }}/uv.lock'

      - name: Install Python dependencies
        working-directory: ${{ env.PYTHON_PROJECT_PATH }}
        run: uv sync --extra dev

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903
        with:
          node-version-file: './test/package.json'
          cache: 'npm'
          cache-dependency-path: './test/package-lock.json'

      - name: Install Appium packages
        working-directory: './test'
        run: npm ci

      - name: List Appium drivers
        working-directory: './test'
        run: npm run list:drivers

      - name: Update workload manifests
        run: dotnet workload config --update-mode manifests

      - name: Restore local .NET tools
        run: dotnet tool restore

      - name: Setup Android SDK (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo apt-get update && sudo apt-get install -y openjdk-21-jdk
          echo "JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64" >> "$GITHUB_ENV"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          curl -fsSL "https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip" -o android-cmdline-tools.zip
          unzip -q android-cmdline-tools.zip && mv cmdline-tools "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> "$GITHUB_PATH"
          echo "$ANDROID_SDK_ROOT/platform-tools" >> "$GITHUB_PATH"
          mkdir -p "$ANDROID_SDK_ROOT/licenses"
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > "$ANDROID_SDK_ROOT/licenses/android-sdk-license"
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> "$ANDROID_SDK_ROOT/licenses/android-sdk-license"
          echo "84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_SDK_ROOT/licenses/android-sdk-preview-license"
          "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" "platform-tools" "platforms;android-$ANDROID_API_LEVEL" "build-tools;$ANDROID_API_LEVEL.0.0"

      - name: Install .NET workloads (Linux)
        if: runner.os == 'Linux'
        run: dotnet workload install maui-android

      - name: Install .NET workloads (Windows)
        if: runner.os == 'Windows'
        run: dotnet workload install maui

      - name: Install .NET workloads (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          sudo xcodebuild -license accept
          dotnet workload install maui-ios maui-maccatalyst

      - name: Test Python project
        working-directory: ${{ env.PYTHON_PROJECT_PATH }}
        run: uv run pytest --cov=src --cov-report=xml --cov-report=term-missing --cov-report=html tests/

      - name: Build .NET
        run: dotnet build --configuration ${{ env.BUILD_CONFIGURATION }}

      - name: Test .NET
        run: dotnet test --configuration ${{ env.BUILD_CONFIGURATION }} --no-build --no-restore

      - name: Create SBOM directory (Linux/macOS)
        if: runner.os != 'Windows'
        run: mkdir -p "${{ github.workspace }}/sbom/${{ matrix.os }}"

      - name: Create SBOM directory (Windows)
        if: runner.os == 'Windows'
        run: New-Item -ItemType Directory -Force -Path "${{ github.workspace }}/sbom/${{ matrix.os }}"

      - name: Generate .NET SBOM
        run: dotnet tool run sbom-tool generate -DeleteManifestDirIfPresent true -BuildDropPath "${{ github.workspace }}/sbom/${{ matrix.os }}" -FetchLicenseInformation true -EnablePackageMetadataParsing true -BuildComponentPath . -PackageName "AITest" -PackageSupplier "VeikkoEeva" -NamespaceUriBase "https://aitest.xyz/aitest" -PackageVersion 1.0.0 -Verbosity Verbose

      - name: Export Python dependencies for SBOM
        working-directory: ${{ env.PYTHON_PROJECT_PATH }}
        run: uv export --format requirements-txt --no-hashes -o "${{ github.workspace }}/sbom/${{ matrix.os }}/python-requirements.txt"

      - name: Generate Python SBOM (Linux/macOS)
        if: runner.os != 'Windows'
        working-directory: ${{ env.PYTHON_PROJECT_PATH }}
        run: uv pip list --format json > "${{ github.workspace }}/sbom/${{ matrix.os }}/python-packages.json"

      - name: Generate Python SBOM (Windows)
        if: runner.os == 'Windows'
        working-directory: ${{ env.PYTHON_PROJECT_PATH }}
        run: uv pip list --format json | Out-File -FilePath "${{ github.workspace }}/sbom/${{ matrix.os }}/python-packages.json" -Encoding utf8

      - name: Generate Node.js SBOM (Linux/macOS)
        if: runner.os != 'Windows'
        working-directory: './test'
        run: npm run sbom && cp sbom/node-sbom.cdx.json "${{ github.workspace }}/sbom/${{ matrix.os }}/"

      - name: Generate Node.js SBOM (Windows)
        if: runner.os == 'Windows'
        working-directory: './test'
        run: npm run sbom; Copy-Item sbom/node-sbom.cdx.json "${{ github.workspace }}/sbom/${{ matrix.os }}/"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: test-results-${{ matrix.os }}
          path: |
            ${{ env.PYTHON_PROJECT_PATH }}/htmlcov/
            ${{ env.PYTHON_PROJECT_PATH }}/coverage.xml
            **/TestResults/
          retention-days: 7

      - name: Upload SBOM
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: sbom-${{ matrix.os }}
          path: ${{ github.workspace }}/sbom/${{ matrix.os }}/
          retention-days: 30

      - name: Prune uv cache
        if: always()
        run: uv cache prune --ci